<!DOCTYPE html>
<html>

<head>
    <title>OAuth Debug Helper</title>
    <style>
        body {
            font-family: monospace;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .section {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }

        button {
            background: #238636;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #2ea043;
        }

        .danger {
            background: #da3633;
        }

        .danger:hover {
            background: #f85149;
        }

        pre {
            background: #0d1117;
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
        }

        .success {
            color: #3fb950;
        }

        .error {
            color: #f85149;
        }

        .warning {
            color: #d29922;
        }
    </style>
</head>

<body>
    <h1>üîç OAuth Debug Helper</h1>

    <div class="section">
        <h3>Current URL</h3>
        <pre id="currentUrl"></pre>
        <button onclick="checkForCode()">Check for OAuth Code</button>
    </div>

    <div class="section">
        <h3>Auth Storage</h3>
        <pre id="authStorage"></pre>
        <button onclick="refreshAuthStorage()">Refresh</button>
        <button class="danger" onclick="clearAuthStorage()">Clear Storage</button>
    </div>

    <div class="section">
        <h3>Session Storage</h3>
        <pre id="sessionStorage"></pre>
        <button onclick="refreshSessionStorage()">Refresh</button>
        <button class="danger" onclick="clearSessionStorage()">Clear Session</button>
    </div>

    <div class="section">
        <h3>Actions</h3>
        <button onclick="openApp()">Open App</button>
        <button onclick="testBackendAuth()">Test Backend Auth</button>
        <button class="danger" onclick="fullReset()">Full Reset</button>
    </div>

    <div class="section">
        <h3>Log</h3>
        <pre id="log"></pre>
    </div>

    <script>
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logEl.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function checkForCode() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');

            if (code) {
                log(`‚úÖ OAuth code found: ${code.substring(0, 10)}...`, 'success');
            } else {
                log('‚ùå No OAuth code in URL', 'error');
            }
        }

        function refreshAuthStorage() {
            const authData = localStorage.getItem('auth-storage');
            const el = document.getElementById('authStorage');

            if (authData) {
                try {
                    const parsed = JSON.parse(authData);
                    el.textContent = JSON.stringify(parsed, null, 2);

                    if (parsed.state?.isAuthenticated) {
                        log('‚úÖ User is authenticated', 'success');
                    } else {
                        log('‚ö†Ô∏è User is NOT authenticated', 'warning');
                    }
                } catch (e) {
                    el.textContent = 'Error parsing: ' + authData;
                    log('‚ùå Invalid auth data', 'error');
                }
            } else {
                el.textContent = 'No auth data found';
                log('‚ö†Ô∏è No auth storage', 'warning');
            }
        }

        function refreshSessionStorage() {
            const el = document.getElementById('sessionStorage');
            const oauth_processing = sessionStorage.getItem('oauth_processing');

            el.textContent = JSON.stringify({
                oauth_processing: oauth_processing
            }, null, 2);

            if (oauth_processing) {
                log('‚ö†Ô∏è OAuth processing flag is set', 'warning');
            }
        }

        function clearAuthStorage() {
            localStorage.removeItem('auth-storage');
            log('‚úÖ Auth storage cleared', 'success');
            refreshAuthStorage();
        }

        function clearSessionStorage() {
            sessionStorage.clear();
            log('‚úÖ Session storage cleared', 'success');
            refreshSessionStorage();
        }

        function fullReset() {
            localStorage.clear();
            sessionStorage.clear();
            log('‚úÖ Full reset complete', 'success');
            refreshAuthStorage();
            refreshSessionStorage();
        }

        function openApp() {
            window.open('http://localhost:3000', '_blank');
            log('üåê Opening app in new tab', 'info');
        }

        async function testBackendAuth() {
            try {
                log('üîÑ Testing backend auth endpoint...', 'info');
                const response = await fetch('http://localhost:8000/auth/github');

                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ Backend auth endpoint working', 'success');
                    log(`Authorization URL: ${data.authorization_url}`, 'info');
                } else {
                    log(`‚ùå Backend returned ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Backend error: ${error.message}`, 'error');
            }
        }

        // Initialize
        document.getElementById('currentUrl').textContent = window.location.href;
        refreshAuthStorage();
        refreshSessionStorage();
        checkForCode();
        log('üöÄ Debug helper loaded', 'success');

        // Auto-refresh every 2 seconds
        setInterval(() => {
            refreshAuthStorage();
            refreshSessionStorage();
        }, 2000);
    </script>
</body>

</html>